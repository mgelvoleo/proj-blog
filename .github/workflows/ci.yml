name: Blog CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set image version
        run: echo "IMAGE_VERSION=8.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/php-fpm-mysql:${{ env.IMAGE_VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/php-fpm-mysql:latest

  cleanup-old-images:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Delete old Docker Hub image tags
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_PASSWORD }}
          IMAGE_NAME: php-fpm-mysql  # Corrected
          KEEP_LAST: 3
        run: |
          # Get authentication token
          TOKEN=$(curl -s -X POST https://hub.docker.com/v2/users/login/ \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$DOCKER_USER\", \"password\": \"$DOCKER_PASS\"}" \
            | jq -r .token)

          # Fetch and filter tags (updated pattern)
          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            https://hub.docker.com/v2/repositories/$DOCKER_USER/$IMAGE_NAME/tags/?page_size=100 \
            | jq -r '.results[].name' | grep '^8\.' | sort -V) # Matches 8.x

          # Calculate tags to delete
          DELETE_TAGS=$(echo "$TAGS" | head -n -$KEEP_LAST)

          # Debug output
          echo "Repository: $DOCKER_USER/$IMAGE_NAME"
          echo "All version tags: $TAGS"
          echo "Tags to delete (keeping last $KEEP_LAST): $DELETE_TAGS"

          # Delete tags
          for tag in $DELETE_TAGS; do
            echo "Deleting tag: $tag"
            curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
              https://hub.docker.com/v2/repositories/$DOCKER_USER/$IMAGE_NAME/tags/$tag/
          done
          echo "Cleanup completed."

  deploy-to-kubernetes:
    needs: build-and-push
    runs-on: self-hosted  # Your self-hosted runner with kubectl access
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set image version
        run: echo "IMAGE_VERSION=8.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Update PHP deployment manifest with new image version
        run: |
          # Update PHP deployment with new image tag
          sed -i "s|image:.*php-fpm-mysql:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/php-fpm-mysql:${{ env.IMAGE_VERSION }}|g" manifest/php/php-deployment.yml
          
          # Display the updated manifest for verification
          echo "=== Updated PHP Deployment ==="
          cat manifest/php/php-deployment.yml | grep -A 2 "image:"

      - name: Apply PHP deployment changes
        run: |
          kubectl apply -f manifest/php/php-deployment.yml

      - name: Wait for deployment rollout
        run: |
          kubectl rollout status deployment/php-fpm -n dev --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n dev
          echo ""
          echo "=== Deployment Info ==="
          kubectl describe deployment php-fpm -n dev | grep -A 5 "Image:"

  rollback-on-failure:
    needs: deploy-to-kubernetes
    runs-on: self-hosted
    if: failure()
    
    steps:
      - name: Rollback to previous version
        run: |
          echo "Deployment failed, rolling back..."
          kubectl rollout undo deployment/php-fpm -n dev
          kubectl rollout status deployment/php-fpm -n dev --timeout=3m